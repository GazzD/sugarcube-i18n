{"version":3,"file":"sugarcube-i18n.esm.js","sources":["../src/core.js","../src/macros.js","../src/index.js"],"sourcesContent":["\"use strict\";\r\n\r\nexport const STATE_VAR_NAME = \"lang\"; // Legacy: Kept if user manually accesses $lang, though plugin no longer relies on it for truth.\r\n// Actually, user requested cleanup. Let's remove it but we might break external scripts relying on $lang.\r\n// Let's keep it but stop syncing? No, better to remove confusion.\r\n// If we remove logic, we don't need the constant.\r\n\r\nconst I18NEXT_CDN = \"https://unpkg.com/i18next@latest/i18next.min.js\";\r\n\r\nconst i18nOptions = {\r\n  debug: true,\r\n  fallbackLng: \"en\",\r\n  resources: {}\r\n};\r\n\r\nfunction loadScript(src) {\r\n  // Load the script\r\n  return new Promise((resolve, reject) => {\r\n    // If i18next is already loaded, return it\r\n    if (window.i18next) return resolve();  \r\n    const script = document.createElement(\"script\");\r\n    script.src = src;\r\n    script.onload = resolve;\r\n    script.onerror = () => reject(new Error(`Failed to load ${src}`));\r\n    document.head.appendChild(script);\r\n  });\r\n}\r\n\r\n\r\nexport function getAvailableLanguages() {\r\n  const i18nTag = \"i18n\";\r\n  const prefix = \"i18n-\";\r\n  const passages = Story.filter(p => p.tags.includes(i18nTag));\r\n  \r\n  const languages = new Set();\r\n  \r\n  // Add default/fallback language\r\n  languages.add(\"en\"); \r\n  \r\n  passages.forEach(p => {\r\n    if (p.title.startsWith(prefix)) {\r\n        languages.add(p.title.substring(prefix.length));\r\n    }\r\n  });\r\n\r\n  return Array.from(languages);\r\n}\r\n\r\nfunction loadDataPassages() {\r\n  // Find all passages with the tag 'i18n'\r\n  const i18nTag = \"i18n\";\r\n  const prefix = \"i18n-\";\r\n  const passages = Story.filter(function(passage) { return passage.tags.includes(i18nTag); });\r\n  \r\n  passages.forEach(passage => {\r\n    try {\r\n      // Remove \"i18n-\" prefix if present\r\n      let lang = \"en\"; // Default\r\n      \r\n      // Try to determine language from passage name (e.g., \"i18n-en\", \"i18n-es\")\r\n      if (passage.title.startsWith(prefix)) {\r\n          lang = passage.title.substring(prefix.length); // Remove \"i18n-\"\r\n      } else {\r\n          console.warn(`[i18n] Passage \"${passage.title}\" has tag '${i18nTag}' but name does not start with \"${prefix}\". Skipping.`);\r\n          return;\r\n      }\r\n      \r\n      const data = JSON.parse(passage.text);\r\n      \r\n      if (!i18nOptions.resources[lang]) {\r\n        i18nOptions.resources[lang] = { translation: {} };\r\n      }\r\n      \r\n      // Merge\r\n      Object.assign(i18nOptions.resources[lang].translation, data);\r\n      console.log(`[i18n] Loaded data passage: ${passage.title} (${lang})`);\r\n      \r\n    } catch (e) {\r\n      console.error(`[i18n] Failed to parse JSON in passage \"${passage.title}\":`, e);\r\n    }\r\n  });\r\n}\r\n\r\n\r\n\r\nexport async function initI18n() {\r\n  await loadScript(I18NEXT_CDN);\r\n\r\n  // Load translations from data passages\r\n  loadDataPassages();\r\n\r\n  let initialLang = \"en\";\r\n  \r\n  // Priority 1: Settings API (Global User Preference)\r\n  if (settings.i18n_lang) {\r\n      initialLang = settings.i18n_lang;\r\n  } \r\n  // Priority 2: Browser Navigator\r\n  else if (navigator.language) {\r\n    initialLang = navigator.language.split(\"-\")[0];\r\n  }\r\n\r\n  await i18next.init({\r\n    ...i18nOptions,\r\n    lng: initialLang,\r\n    interpolation: { escapeValue: false }\r\n  });\r\n\r\n  console.log(`[i18n] Initialized (${i18next.language})`);\r\n}\r\n\r\nexport function setLang(lang) {\r\n  if (settings.i18n_lang !== lang) {\r\n      settings.i18n_lang = lang;\r\n      Setting.save(); // Ensure persistence\r\n  }\r\n  return i18next.changeLanguage(lang);\r\n}\r\n\r\n\r\nexport function translate(key, options = {}) {\r\n  return window.i18next ? i18next.t(key, options) : key;\r\n}\r\n","import { translate, setLang } from \"./core.js\";\r\n\r\nexport function registerMacros() {\r\n\r\n  /**\r\n     * Macro: <<loadTranslations \"path/to/file.json\" [namespace]>>\r\n     * Loads a JSON file and adds it to i18next resources.\r\n     *\r\n     * Convention:\r\n     * The JSON file should be structured as:\r\n     * {\r\n     *   \"key\": \"translation\"\r\n     * }\r\n     *\r\n     * Usage: <<loadTranslations \"locales/en.json\" \"en\">>\r\n     */\r\n    Macro.add('loadTranslations', {\r\n        handler: function () {\r\n            if (this.args.length < 2) {\r\n                return this.error(\"Usage: <<loadTranslations 'path' 'langCode'>>\");\r\n            }\r\n\r\n            const path = this.args[0];\r\n            const lang = this.args[1];\r\n            const ns = 'translation'; // default namespace\r\n\r\n            // fetch is async, but macros in Init/StoryInit are synchronous. \r\n            // SugarCube doesn't pause for async macros in Init usually, but content won't render till ready if used in Passages.\r\n            \r\n            fetch(path)\r\n                .then(response => {\r\n                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);\r\n                    return response.json();\r\n                })\r\n                .then(data => {\r\n                    if (window.i18next) {\r\n                        i18next.addResourceBundle(lang, ns, data, true, true);\r\n                        console.log(`[i18n] Loaded translations for ${lang} from ${path}`);\r\n                        // If this is the current language, trigger a refresh might be needed if passage is already shown?\r\n                        // Usually this is done in StoryInit so no passage is shown yet.\r\n                        \r\n                        // Force update engine if we are currently looking at this language\r\n                        if (i18next.language === lang) {\r\n                           Engine.show(); // Refreshes current passage if needed, though be careful in Init\r\n                        }\r\n                    }\r\n                })\r\n                .catch(err => {\r\n                    console.error(`[i18n] Failed to load ${path}:`, err);\r\n                    $(this.output).append(`<span class=\"error\">i18n Error: Failed to load ${path}</span>`);\r\n                });\r\n        }\r\n    });\r\n\r\n    /**\r\n     * Macro: <<setLang \"code\">>\r\n     * Changes the current language and updates persistence.\r\n     */\r\n    Macro.add('setLang', {\r\n       handler() { \r\n        const lang = this.args[0]; \r\n        setLang(lang).then(() => Engine.show()); \r\n       } \r\n    });\r\n\r\n    /**\r\n     * Macro: <<t \"key\" [options]>>\r\n     * Translates a key. Supports interpolation.\r\n     * Options can be an object or key-value pairs.\r\n     * Example:\r\n     *  - Object options: \r\n     *       <<set $opts to { name: $name }>>\r\n     *       <<t \"greeting\" $opts>>\r\n     *  - Key-Value pairs options:\r\n     *       <<t \"greeting\" \"name\" $name>>\r\n     */\r\n    Macro.add('t', {\r\n        handler() {\r\n            if (this.args.length === 0) {\r\n                return this.error(\"Usage: <<t 'key' [options]>>\");\r\n            }\r\n\r\n            const key = this.args[0];\r\n            let options = {};\r\n            const second = this.args[1];\r\n            if (this.args.length > 1 && typeof second === \"object\" && !Array.isArray(second)) {\r\n              // Object form\r\n              options = second;\r\n            } else {\r\n              // Key-value pairs form\r\n              if ((this.args.length - 1) % 2 !== 0) {\r\n                return this.error(\r\n                  \"<<t>> expects key-value pairs or an options object\"\r\n                );\r\n              }\r\n\r\n              for (let i = 1; i < this.args.length; i += 2) {\r\n                options[this.args[i]] = this.args[i + 1];\r\n              }\r\n            }\r\n\r\n            const text = translate(key, options);\r\n            $(this.output).append($(\"<span>\").html(text));\r\n        }\r\n    });\r\n\r\n    /**\r\n     * Macro: <<tlink \"key\" \"passage\" [options]>>\r\n     * Translates a key and creates a link to a passage. Supports interpolation.\r\n     * Options can be an object or key-value pairs.\r\n     * Example:\r\n     * <<tlink \"go-to-forest\" \"ForestPassage\">>\r\n     * <<tlink \"go-to-forest\" \"ForestPassage\" { name: $name }>>\r\n     * <<tlink \"go-to-forest\" \"ForestPassage\" \"name\" $name>>\r\n     */\r\n    Macro.add(\"tlink\", {\r\n      handler() {\r\n        const key = this.args[0];\r\n        const passage = this.args[1];\r\n        let options = {}; \r\n\r\n        if (this.args.length > 2) {\r\n          const second = this.args[2];\r\n          if (second && typeof second === \"object\") {\r\n            options = second;\r\n          } else {\r\n            for (let i = 2; i < this.args.length; i += 2) {\r\n              options[this.args[i]] = this.args[i + 1];\r\n            }\r\n          }\r\n        }\r\n        const label = translate(key, options);\r\n        new Wikifier(this.output, `<<link \"${label}\" \"${passage}\">><</link>>`);\r\n      }\r\n    });\r\n\r\n}\r\n","import { initI18n, getAvailableLanguages, setLang } from \"./core.js\";\r\nimport { registerMacros } from \"./macros.js\";\r\n\r\nregisterMacros();\r\n\r\n(async function () {\r\n  try {\r\n\r\n    // Lock the loading screen.\r\n    var lockId = LoadScreen.lock();\r\n\r\n    // Initialize i18n plugin configuration\r\n    await initI18n();\r\n    \r\n    // Release the loading screen.\r\n    LoadScreen.unlock(lockId);\r\n    \r\n  } catch (err) {\r\n    console.error(\"[i18n] Init failed\", err);\r\n  }\r\n})();\r\n\r\n\r\n// Save / Load hooks\r\n// No longer syncing strict state variable, relying on Global Settings.\r\n// However, if we want to support \"saving in English then loading a save that was in Spanish\",\r\n// with purely Settings based approach, loading the Spanish save will keep the game in English (user pref).\r\n// This is usually desired behavior for \"Application Language\".\r\n\r\n// Automatic Settings Integration\r\nfunction initSettings() {\r\n    const langs = getAvailableLanguages();\r\n    if (langs.length > 1) {\r\n        Setting.addList(\"i18n_lang\", {\r\n            label: \"Language\",\r\n            list: langs,\r\n            default: settings.i18n_lang || langs[0],\r\n            onInit: function () {},\r\n            onChange: function () {\r\n                const newLang = settings.i18n_lang;\r\n                if (window.i18next && newLang) {\r\n                    setLang(newLang).then(() => Engine.show());\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\ninitSettings();\r\n\r\n\r\n$(document).on(\":storyready\", () => {\r\n    // If we have a setting saved, ensure i18next respects it on story ready\r\n    if (settings.i18n_lang && window.i18next) {\r\n        if (i18next.language !== settings.i18n_lang) {\r\n             setLang(settings.i18n_lang);\r\n        }\r\n    } \r\n});\r\n"],"names":["i18nOptions","debug","fallbackLng","resources","async","initI18n","src","Promise","resolve","reject","window","i18next","script","document","createElement","onload","onerror","Error","head","appendChild","i18nTag","prefix","Story","filter","passage","tags","includes","forEach","lang","title","startsWith","console","warn","substring","data","JSON","parse","text","translation","Object","assign","log","e","error","loadDataPassages","initialLang","settings","i18n_lang","navigator","language","split","init","lng","interpolation","escapeValue","setLang","Setting","save","changeLanguage","translate","key","options","t","Macro","add","handler","this","args","length","path","fetch","then","response","ok","status","json","addResourceBundle","Engine","show","catch","err","$","output","append","second","Array","isArray","i","html","label","Wikifier","lockId","LoadScreen","lock","unlock","langs","passages","p","languages","Set","from","getAvailableLanguages","addList","list","default","onInit","onChange","newLang","initSettings","on"],"mappings":"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"}