{"version":3,"file":"sugarcube-i18n.esm.js","sources":["../src/core.js","../src/macros.js","../src/index.js"],"sourcesContent":["\"use strict\";\n\nexport const STATE_VAR_NAME = \"lang\";\nconst I18NEXT_CDN = \"https://unpkg.com/i18next@latest/i18next.min.js\";\n\nconst i18nOptions = {\n  debug: true,\n  fallbackLng: \"en\",\n  resources: {}\n};\n\nfunction loadScript(src) {\n  // Load the script\n  return new Promise((resolve, reject) => {\n    // If i18next is already loaded, return it\n    if (window.i18next) return resolve();  \n    const script = document.createElement(\"script\");\n    script.src = src;\n    script.onload = resolve;\n    script.onerror = () => reject(new Error(`Failed to load ${src}`));\n    document.head.appendChild(script);\n  });\n}\n\nexport async function initI18n() {\n  await loadScript(I18NEXT_CDN);\n\n  let initialLang = \"en\";\n  if (State.variables[STATE_VAR_NAME]) {\n    initialLang = State.variables[STATE_VAR_NAME];\n  } else if (navigator.language) {\n    initialLang = navigator.language.split(\"-\")[0];\n  }\n\n  await i18next.init({\n    ...i18nOptions,\n    lng: initialLang,\n    interpolation: { escapeValue: false }\n  });\n\n  if (!State.variables[STATE_VAR_NAME]) {\n    State.variables[STATE_VAR_NAME] = i18next.language;\n  }\n\n  console.log(`[i18n] Initialized (${i18next.language})`);\n}\n\nexport function setLang(lang) {\n  return i18next.changeLanguage(lang).then(() => {\n    State.variables[STATE_VAR_NAME] = lang;\n  });\n}\n\nexport function translate(key, options = {}) {\n  return window.i18next ? i18next.t(key, options) : key;\n}\n","import { translate, setLang } from \"./core.js\";\n\nexport function registerMacros() {\n\n  /**\n     * Macro: <<loadTranslations \"path/to/file.json\" [namespace]>>\n     * Loads a JSON file and adds it to i18next resources.\n     *\n     * Convention:\n     * The JSON file should be structured as:\n     * {\n     *   \"key\": \"translation\"\n     * }\n     *\n     * Usage: <<loadTranslations \"locales/en.json\" \"en\">>\n     */\n    Macro.add('loadTranslations', {\n        handler: function () {\n            if (this.args.length < 2) {\n                return this.error(\"Usage: <<loadTranslations 'path' 'langCode'>>\");\n            }\n\n            const path = this.args[0];\n            const lang = this.args[1];\n            const ns = 'translation'; // default namespace\n\n            // fetch is async, but macros in Init/StoryInit are synchronous. \n            // SugarCube doesn't pause for async macros in Init usually, but content won't render till ready if used in Passages.\n            // For MVP, we assume this is called in StoryInit and might take a moment.\n            \n            fetch(path)\n                .then(response => {\n                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);\n                    return response.json();\n                })\n                .then(data => {\n                    if (window.i18next) {\n                        i18next.addResourceBundle(lang, ns, data, true, true);\n                        console.log(`[i18n] Loaded translations for ${lang} from ${path}`);\n                        // If this is the current language, trigger a refresh might be needed if passage is already shown?\n                        // Usually this is done in StoryInit so no passage is shown yet.\n                        \n                        // Force update engine if we are currently looking at this language\n                        if (i18next.language === lang) {\n                           Engine.show(); // Refreshes current passage if needed, though be careful in Init\n                        }\n                    }\n                })\n                .catch(err => {\n                    console.error(`[i18n] Failed to load ${path}:`, err);\n                    $(this.output).append(`<span class=\"error\">i18n Error: Failed to load ${path}</span>`);\n                });\n        }\n    });\n\n    /**\n     * Macro: <<setLang \"code\">>\n     * Changes the current language and updates persistence.\n     */\n    Macro.add('setLang', {\n       handler() { \n        const lang = this.args[0]; \n        setLang(lang).then(() => Engine.show()); \n       } \n    });\n\n    /**\n     * Macro: <<t \"key\" [options]>>\n     * Translates a key. Supports interpolation.\n     * Options can be an object or key-value pairs.\n     * Example:\n     *  - Object options: \n     *       <<set $opts to { name: $name }>>\n     *       <<t \"greeting\" $opts>>\n     *  - Key-Value pairs options:\n     *       <<t \"greeting\" \"name\" $name>>\n     */\n    Macro.add('t', {\n        handler() {\n            if (this.args.length === 0) {\n                return this.error(\"Usage: <<t 'key' [options]>>\");\n            }\n\n            const key = this.args[0];\n            let options = {};\n            const second = this.args[1];\n            if (this.args.length > 1 && typeof second === \"object\" && !Array.isArray(second)) {\n              // Object form\n              options = second;\n            } else {\n              // Key-value pairs form\n              if ((this.args.length - 1) % 2 !== 0) {\n                return this.error(\n                  \"<<t>> expects key-value pairs or an options object\"\n                );\n              }\n\n              for (let i = 1; i < this.args.length; i += 2) {\n                options[this.args[i]] = this.args[i + 1];\n              }\n            }\n\n            const text = translate(key, options); $(this.output).append($(\"<span>\").html(text));\n        }\n    });\n\n    /**\n     * Macro: <<tlink \"key\" \"passage\" [options]>>\n     * Translates a key and creates a link to a passage. Supports interpolation.\n     * Options can be an object or key-value pairs.\n     * Example:\n     * <<tlink \"go-to-forest\" \"ForestPassage\">>\n     * <<tlink \"go-to-forest\" \"ForestPassage\" { name: $name }>>\n     * <<tlink \"go-to-forest\" \"ForestPassage\" \"name\" $name>>\n     */\n    Macro.add(\"tlink\", {\n      handler() {\n        const key = this.args[0];\n        const passage = this.args[1];\n        let options = {}; \n\n        if (this.args.length > 2) {\n          const second = this.args[2];\n          if (second && typeof second === \"object\") {\n            options = second;\n          } else {\n            for (let i = 2; i < this.args.length; i += 2) {\n              options[this.args[i]] = this.args[i + 1];\n            }\n          }\n        }\n        const label = translate(key, options);\n        new Wikifier(this.output, `<<link \"${label}\" \"${passage}\">><</link>>`);\n      }\n    });\n\n}\n","import { initI18n, STATE_VAR_NAME } from \"./core.js\";\nimport { registerMacros } from \"./macros.js\";\n\nregisterMacros();\n\n(async function () {\n  try {\n\n    // Lock the loading screen.\n    var lockId = LoadScreen.lock();\n\n    // Initialize i18n plugin configuration\n    await initI18n();\n    \n    // Release the loading screen.\n    LoadScreen.unlock(lockId);\n    \n  } catch (err) {\n    console.error(\"[i18n] Init failed\", err);\n  }\n})();\n\n// Save / Load hooks\nSave.onLoad.add(save => {\n  const moment = save?.state?.history?.[save.state.index];\n  const lang = moment?.variables?.[STATE_VAR_NAME];\n  if (lang && window.i18next) {\n    i18next.changeLanguage(lang);\n  }\n});\n\n$(document).on(\":storyready\", () => {\n  if (window.i18next && State.variables[STATE_VAR_NAME]) {\n    i18next.changeLanguage(State.variables[STATE_VAR_NAME]);\n  }\n});\n"],"names":["STATE_VAR_NAME","i18nOptions","debug","fallbackLng","resources","async","initI18n","src","Promise","resolve","reject","window","i18next","script","document","createElement","onload","onerror","Error","head","appendChild","initialLang","State","variables","navigator","language","split","init","lng","interpolation","escapeValue","console","log","translate","key","options","t","Macro","add","handler","this","args","length","error","path","lang","fetch","then","response","ok","status","json","data","addResourceBundle","Engine","show","catch","err","$","output","append","changeLanguage","setLang","second","Array","isArray","i","text","html","passage","label","Wikifier","lockId","LoadScreen","lock","unlock","Save","onLoad","save","moment","state","history","index","on"],"mappings":"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"}